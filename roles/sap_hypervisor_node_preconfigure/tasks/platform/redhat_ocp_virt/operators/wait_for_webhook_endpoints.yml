---
- name: Wait for webhook endpoints
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Endpoints
    name: "{{ webhook_service_name }}"
    namespace: "{{ webhook_namespace }}"
  register: webhook_endpoints
  until:
    - webhook_endpoints is defined
    - webhook_endpoints.resources | length > 0
    - webhook_endpoints.resources[0].subsets is defined
    - webhook_endpoints.resources[0].subsets | length > 0
    - webhook_endpoints.resources[0].subsets[0].addresses is defined
    - webhook_endpoints.resources[0].subsets[0].addresses | length > 0
  retries: "{{ webhook_retries | default(30) }}"
  delay: "{{ webhook_delay | default(10) }}"

- name: Fail if webhook endpoints never became available
  ansible.builtin.fail:
    msg: >
      Webhook {{ webhook_service_name }} in namespace
      {{ webhook_namespace }} did not become available in time.
  when: webhook_endpoints is failed
