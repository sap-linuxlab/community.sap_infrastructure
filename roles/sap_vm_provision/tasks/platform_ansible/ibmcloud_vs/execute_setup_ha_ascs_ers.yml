# SPDX-License-Identifier: Apache-2.0
---

# Temporary ports are set now, then updated in post_deployment.

- name: SAP VM Provision - IBM Cloud - Set fact with Load Balancers for SAP ASCS/ERS
  ansible.builtin.set_fact:
    __sap_vm_provision_register_ibmcloud_lbs_ascs_id: >-
      {{ __sap_vm_provision_register_ibmcloud_lbs_all_info
        | selectattr('name', 'equalto', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs')
        | map(attribute='id') | first | d(none) }}

    __sap_vm_provision_register_ibmcloud_lbs_ers_id: >-
      {{ __sap_vm_provision_register_ibmcloud_lbs_all_info
        | selectattr('name', 'equalto', sap_vm_provision_ha_load_balancer_name_nwas + '-ers')
        | map(attribute='id') | first | d(none) }}

    __sap_vm_provision_register_ibmcloud_lbs_pools: >-
      {{ __sap_vm_provision_register_ibmcloud_lbs_all_info
        | map(attribute='pools') | flatten }}


- name: Block when pool ID exists
  when: __sap_vm_provision_register_ibmcloud_lbs_ascs_id is not none
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:

    # Dispatcher
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapdp<ASCS_NN> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-dp' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs1

    # Message Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapms<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs2

    # Message Server HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapms<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms-http' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs3

    # Enqueue Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapenq<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enq' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs4

    # Enqueue Replicator Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapenqrepl<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enqrepl' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs5

    # SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapctrl<ASCS_NN> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrl' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs6

    # SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ASCS - sapctrls<ASCS_NN> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrls' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55551
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ascs7

    # # Dispatcher
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ERS - sapdp<ERS_NN> process
    #   ibm.cloudcollection.ibm_is_lb_pool:
    #     name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-dp' }}"
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     algorithm: weighted_round_robin
    #     protocol: tcp
    #     health_delay: 20
    #     health_retries: 2
    #     health_timeout: 10
    #     health_type: tcp
    #     health_monitor_port: 55552
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ers1

    # # Message Server
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ERS - sapms<SAPSID> process
    #   ibm.cloudcollection.ibm_is_lb_pool:
    #     name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-ms' }}"
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     algorithm: weighted_round_robin
    #     protocol: tcp
    #     health_delay: 20
    #     health_retries: 2
    #     health_timeout: 10
    #     health_type: tcp
    #     health_monitor_port: 55552
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ers2

    # Enqueue Replication Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ERS - sapenqr<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-enqr' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55552
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ers3

    # SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ERS - sapctrl<ERS_NN> process
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrl' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55552
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ers4

    # SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool for SAP NetWeaver ERS - sapctrls<ERS_NN>
      ibm.cloudcollection.ibm_is_lb_pool:
        name: "{{ sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrls' }}"
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        algorithm: weighted_round_robin
        protocol: tcp
        health_delay: 20
        health_retries: 2
        health_timeout: 10
        health_type: tcp
        health_monitor_port: 55552
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_pool_nwas_ers5

# Identify the provisioned IBM Cloud Load Balancer Back-end Pools

- name: Identify IBM Cloud Load Balancer Back-end Pools
  no_log: "{{ __sap_vm_provision_no_log }}"
  register: __sap_vm_provision_register_ibmcloud_lb_pools
  ibm.cloudcollection.ibm_is_lb_pools_info:
    lb: "{{ item }}"
    ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
  loop: "{{ __sap_vm_provision_register_ibmcloud_lbs_all_info | map(attribute='id') }}"


# Create IBM Cloud Load Balancer Front-end Listeners (open port for Virtual IPs)
# Configure prior to Back-end Pool Server Members, as this will increase execution speed
# by avoiding LB verification check/reload once the LB is active with Server Members

# When IBM Cloud Load Balancer, Application Load Balancer Type:
# - Important to increase the Front-end Listener Idle Connection Timeout (sec),
#   if the received-and-forwarded request becomes idle (no data received/sent sent/received)
#   then the idle connection is closed by default/minimum after 50 seconds and maximum 7200 seconds (2 hours).
# - This can impact SAP SWPM waiting for SAP HANA Data Load to complete, and other long-running actions.

# Block will be executed only if 'sap_system_nwas_abap_ascs_instance_nr' is defined and not empty.
- name: Block when required instance numbers are defined for ASCS
  when:
    - sap_system_nwas_abap_ascs_instance_nr | d('') | length > 0
    - __sap_vm_provision_register_ibmcloud_lbs_ascs_id is not none
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:

    # Dispatcher
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapdp<ASCS_NN> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-dp'))[0].id }}"
        protocol: tcp
        port: "{{ ('32' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs1
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs1.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs1.stderr

    # Message Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapms<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms'))[0].id }}"
        protocol: tcp
        port: "{{ ('36' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs2
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs2.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs2.stderr

    # Message Server HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapms<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms-http'))[0].id }}"
        protocol: tcp
        port: "{{ ('81' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs3
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs3.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs3.stderr

    # Enqueue Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapenq<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enq'))[0].id }}"
        protocol: tcp
        port: "{{ ('39' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs4
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs4.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs4.stderr

    # Enqueue Replicator Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapenqrepl<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enqrepl'))[0].id }}"
        protocol: tcp
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '16') | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs5
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs5.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs5.stderr

    # SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapctrl<ASCS_NN> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrl'))[0].id }}"
        protocol: tcp
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '13') | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs6
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs6.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs6.stderr

    # SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ASCS - sapctrls<ASCS_NN>
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrls'))[0].id }}"
        protocol: tcp
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '14') | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs7
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs7.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ascs7.stderr


    # Append Server Members to the IBM Cloud Load Balancer Back-end Pools

    # Primary and Secondary for Dispatcher
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapdp<ASCS_NN> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-dp'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('32' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs1
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs1.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs1.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapdp<ASCS_NN> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-dp'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('32' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs2
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs2.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs2.stderr

    # Primary and Secondary for Message Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapms<SAPSID> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('36' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs3
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs3.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs3.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapms<SAPSID> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('36' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs4
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs4.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs4.stderr

    # Primary and Secondary for Message Server HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapms<SAPSID> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms-http'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('81' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs5
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs5.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs5.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapms<SAPSID> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-ms-http'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('81' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs6
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs6.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs6.stderr

    # Primary and Secondary for Enqueue Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapenq<SAPSID> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enq'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('39' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs7
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs7.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs7.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapenq<SAPSID> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enq'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('39' + sap_system_nwas_abap_ascs_instance_nr) | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs8
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs8.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs8.stderr

    # Primary and Secondary for Enqueue Replicator Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapenqrepl<SAPSID> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enqrepl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '16') | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs9
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs9.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs9.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapenqrepl<SAPSID> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-enqrepl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '16') | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs10
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs10.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs10.stderr

    # Primary and Secondary for SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapctrl<ASCS_NN> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '13') | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs11
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs11.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs11.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapctrl<ASCS_NN> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '13') | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs12
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs12.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs12.stderr

    # Primary and Secondary for SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapctrls<ASCS_NN> - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrls'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '14') | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs13
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs13.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs13.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ASCS - sapctrls<ASCS_NN> - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ascs_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs-pool-sapctrls'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ascs_instance_nr + '14') | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs14
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs14.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ascs14.stderr


# Block will be executed only if 'sap_system_nwas_abap_ers_instance_nr' is defined and not empty.
- name: Block when required instance numbers are defined for ERS
  when:
    - sap_system_nwas_abap_ers_instance_nr | d('') | length > 0
    - __sap_vm_provision_register_ibmcloud_lbs_ers_id is not none
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:

    # # Dispatcher
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ERS - sapdp<ERS_NN> process
    #   ibm.cloudcollection.ibm_is_lb_listener:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-dp'))[0].id }}"
    #     protocol: tcp
    #     port: "{{ ('32' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     idle_connection_timeout: 600 # 10 minutes
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers1
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers1.rc == 0
    #     - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers1.stderr

    # # Message Server
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ERS - sapms<SAPSID> process
    #   ibm.cloudcollection.ibm_is_lb_listener:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-ms'))[0].id }}"
    #     protocol: tcp
    #     port: "{{ ('36' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     idle_connection_timeout: 600 # 10 minutes
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers2
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers2.rc == 0
    #     - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers2.stderr

    # Enqueue Replication Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ERS - sapenqr<SAPSID> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-enqr'))[0].id }}"
        protocol: tcp
        port: "{{ ('39' + sap_system_nwas_abap_ers_instance_nr) | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers3
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers3.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers3.stderr

    # SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ERS - sapctrl<ERS_NN> process
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrl'))[0].id }}"
        protocol: tcp
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '13') | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers4
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers4.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers4.stderr

    # SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Front-end Listener for SAP NetWeaver ERS - sapctrls<ERS_NN>
      ibm.cloudcollection.ibm_is_lb_listener:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        default_pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrls'))[0].id }}"
        protocol: tcp
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '14') | int }}"
        idle_connection_timeout: 600 # 10 minutes
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers5
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers5.rc == 0
        - not 'listener_duplicate_port' in __sap_vm_provision_register_ibmcloud_lb_frontend_listener_ers5.stderr


    # Append Server Members to the IBM Cloud Load Balancer Back-end Pools

    # # Primary and Secondary for Dispatcher
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapdp<ERS_NN> process - Member 1
    #   ibm.cloudcollection.ibm_is_lb_pool_member:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-dp'))[0].id }}"
    #     target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
    #       | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
    #     port: "{{ ('32' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     weight: 100
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
    #   loop_control:
    #     loop_var: host_node
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers1
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers1.rc == 0
    #     - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers1.stderr

    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapdp<ERS_NN> process - Member 2
    #   ibm.cloudcollection.ibm_is_lb_pool_member:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-dp'))[0].id }}"
    #     target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
    #       | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
    #     port: "{{ ('32' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     weight: 1
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
    #   loop_control:
    #     loop_var: host_node
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers2
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers2.rc == 0
    #     - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers2.stderr

    # # Primary and Secondary for Message Server
    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapms<SAPSID> process - Member 1
    #   ibm.cloudcollection.ibm_is_lb_pool_member:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-ms'))[0].id }}"
    #     target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
    #       | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
    #     port: "{{ ('36' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     weight: 100
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
    #   loop_control:
    #     loop_var: host_node
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers3
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers3.rc == 0
    #     - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers3.stderr

    # - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapms<SAPSID> process - Member 2
    #   ibm.cloudcollection.ibm_is_lb_pool_member:
    #     lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
    #     pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
    #       | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-ms'))[0].id }}"
    #     target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
    #       | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
    #     port: "{{ ('36' + sap_system_nwas_abap_ers_instance_nr) | int }}"
    #     weight: 1
    #     ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
    #   loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
    #   loop_control:
    #     loop_var: host_node
    #   register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers4
    #   failed_when:
    #     - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers4.rc == 0
    #     - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers4.stderr

    # Primary and Secondary for Enqueue Replication Server
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapenqr<SAPSID> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-enqr'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('39' + sap_system_nwas_abap_ers_instance_nr) | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers5
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers5.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers5.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapenqr<SAPSID> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-enqr'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('39' + sap_system_nwas_abap_ers_instance_nr) | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers6
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers6.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers6.stderr


    # Primary and Secondary for SAP Start Service (SAPControl SOAP) HTTP
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapctrl<ERS_NN> process - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '13') | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers7
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers7.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers7.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapctrl<ERS_NN> process - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrl'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '13') | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers8
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers8.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers8.stderr


    # Primary and Secondary for SAP Start Service (SAPControl SOAP) HTTPS (Secure)
    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapctrls<ERS_NN> - Member 1
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrls'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '14') | int }}"
        weight: 100
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers9
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers9.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers9.stderr

    - name: SAP VM Provision - IBM Cloud - Create IBM Cloud Load Balancer Back-end Pool Members for SAP NetWeaver ERS - sapctrls<ERS_NN> - Member 2
      ibm.cloudcollection.ibm_is_lb_pool_member:
        lb: "{{ __sap_vm_provision_register_ibmcloud_lbs_ers_id }}"
        pool: "{{ (__sap_vm_provision_register_ibmcloud_lb_pools.results | json_query('[*].resource.pools') | flatten
          | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers-pool-sapctrls'))[0].id }}"
        target_address: "{{ (__sap_vm_provision_register_ibmcloud_vs_all_info.resource.instances
          | selectattr('name', '==', host_node))[0].primary_network_attachment[0].primary_ip[0].address }}"
        port: "{{ ('5' + sap_system_nwas_abap_ers_instance_nr + '14') | int }}"
        weight: 1
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers10
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers10.rc == 0
        - not 'already exists in a pool' in __sap_vm_provision_register_ibmcloud_lb_pool_members_nwas_ers10.stderr


- name: SAP VM Provision - IBM Cloud - IBM Cloud Private DNS Record for SAP NetWeaver ASCS HA Virtual Hostname
  ibm.cloudcollection.ibm_dns_resource_record:
    instance_id: "{{ __sap_vm_provision_register_ibmcloud_pdns_service_instance.resource.guid }}"
    zone_id: "{{ (__sap_vm_provision_register_ibmcloud_pdns.resource.dns_zones
      | selectattr('name', '==', sap_vm_provision_dns_root_domain) | first).zone_id }}"
    name: "{{ __sap_vm_provision_fact_ha_hostname_nwas_abap_ascs }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}" # Host FQDN
    rdata: "{{ (__sap_vm_provision_register_ibmcloud_lbs_all_info
      | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs'))[0].private_ips[0].address }}" # IP Address
    type: A
    ttl: 7200
    ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
  loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
  loop_control:
    loop_var: host_node
  register: __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ascs
  no_log: "{{ __sap_vm_provision_no_log }}"
  failed_when:
    - not __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ascs.rc == 0
    - not 'The record already exists' in __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ascs.stderr

- name: SAP VM Provision - IBM Cloud - IBM Cloud Private DNS Record for SAP NetWeaver ERS HA Virtual Hostname
  ibm.cloudcollection.ibm_dns_resource_record:
    instance_id: "{{ __sap_vm_provision_register_ibmcloud_pdns_service_instance.resource.guid }}"
    zone_id: "{{ (__sap_vm_provision_register_ibmcloud_pdns.resource.dns_zones
      | selectattr('name', '==', sap_vm_provision_dns_root_domain) | first).zone_id }}"
    name: "{{ __sap_vm_provision_fact_ha_hostname_nwas_abap_ers }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}" # Host FQDN
    rdata: "{{ (__sap_vm_provision_register_ibmcloud_lbs_all_info
      | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers'))[0].private_ips[0].address }}" # IP Address
    type: A
    ttl: 7200
    ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
  loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
  loop_control:
    loop_var: host_node
  register: __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ers
  no_log: "{{ __sap_vm_provision_no_log }}"
  failed_when:
    - not __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ers.rc == 0
    - not 'The record already exists' in __sap_vm_provision_register_ibmcloud_pdns_record_ha_nwas_ers.stderr


- name: SAP VM Provision - IBM Cloud - Set facts for all hosts - use facts from localhost - HA/DR - IBM Cloud Load Balancer - SAP NetWeaver ASCS and ERS
  ansible.builtin.set_fact:  # noqa var-naming[no-role-prefix]
    sap_vm_provision_ha_vip_nwas_abap_ascs: "{{ __vip_ip_ascs }}"
    sap_vm_temp_vip_nwas_abap_ascs: "{{ __vip_ip_ascs }}"
    sap_ha_pacemaker_cluster_vip_nwas_abap_ascs_ip_address: "{{ __vip_ip_ascs }}"
    sap_vm_provision_ha_vip_nwas_abap_ers: "{{ __vip_ip_ers }}"
    sap_vm_temp_vip_nwas_abap_ers: "{{ __vip_ip_ers }}"
    sap_ha_pacemaker_cluster_vip_nwas_abap_ers_ip_address: "{{ __vip_ip_ers }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ __sap_vm_provision_fact_merged_hosts_list }}"
  vars:
    __vip_ip_ascs: "{{ (__sap_vm_provision_register_ibmcloud_lbs_all_info
      | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ascs'))[0].private_ips[0].address }}"
    __vip_ip_ers: "{{ (__sap_vm_provision_register_ibmcloud_lbs_all_info
      | selectattr('name', '==', sap_vm_provision_ha_load_balancer_name_nwas + '-ers'))[0].private_ips[0].address }}"
