# SPDX-License-Identifier: Apache-2.0
---

# (SUSE specific) Requirement for fence agent: stonith:external/ec2
# All instances in cluster need to be tagged with tag configured in agent
# sap_ha_pacemaker_cluster role configures default tag name 'pacemaker' with value of 'inventory_hostname_short'
# https://documentation.suse.com/sbp/sap-15/html/SLES4SAP-hana-sr-guide-perfopt-15-aws/index.html#id-tagging-the-ec2-instances
# https://docs.aws.amazon.com/sap/latest/sap-hana/sap-hana-on-aws-stonith-device.html
- name: SAP VM Provision - AWS - Ensure pacemaker tag is present for SUSE
  amazon.aws.ec2_tag:
    resource: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
    state: present
    tags:
      pacemaker: "{{ inventory_hostname_short }}"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  loop:
    "{{
      (groups[sap_vm_provision_group_hana_primary] + groups[sap_vm_provision_group_hana_secondary]
      if sap_vm_provision_fact_is_ha_hana else [])
      + (groups[sap_vm_provision_group_anydb_primary] + groups[sap_vm_provision_group_anydb_secondary]
        if sap_vm_provision_fact_is_ha_anydb else [])
      + (groups[sap_vm_provision_group_nwas_ascs] + groups[sap_vm_provision_group_nwas_ers]
        if sap_vm_provision_fact_is_ha_nwas_ers else [])
    }}"
  loop_control:
    loop_var: host_node
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: ansible_facts['os_family'] == 'Suse'


- name: SAP VM Provision - AWS - Gather information about AWS account
  amazon.aws.aws_caller_info:
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_account_info
  no_log: "{{ __sap_vm_provision_no_log }}"

- name: SAP VM Provision - AWS - Gather information about AWS VPC Route Table for the VPC Subnet
  amazon.aws.ec2_vpc_route_table_info:
    filters:
      association.subnet-id: "{{ sap_vm_provision_aws_vpc_subnet_id }}"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_vpc_subnet_rt_info
  no_log: "{{ __sap_vm_provision_no_log }}"


- name: Block for HANA
  when: sap_vm_provision_fact_is_ha_hana
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:
    - name: SAP VM Provision - AWS - Ansible AWS VPC Route Table append route for SAP HANA HA
      amazon.aws.ec2_vpc_route_table:
        lookup: id
        vpc_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].vpc_id }}"
        route_table_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].route_table_id }}"
        purge_subnets: false
        purge_routes: false
        state: present
        routes:
          - dest: "{{ sap_vm_provision_ha_vip_hana_primary }}"
            instance_id: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_hana_primary] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_vpc_subnet_rt_route_sap_hana

    - name: SAP VM Provision - AWS - Ansible AWS Route53 DNS Records for SAP HANA HA Virtual Hostname
      amazon.aws.route53:
        state: present
        private_zone: true
        zone: "{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        record: "{{ __sap_vm_provision_fact_ha_hostname_hana_primary }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        type: A
        ttl: 7200
        value: "{{ sap_vm_provision_ha_vip_hana_primary | regex_replace('/.*', '') }}"
        wait: true
        overwrite: "{{ sap_vm_provision_aws_dns_overwrite if sap_vm_provision_aws_dns_overwrite | bool else false }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_hana_primary] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_route53_sap_hana


- name: Block for AnyDB
  when: sap_vm_provision_fact_is_ha_anydb
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:
    - name: SAP VM Provision - AWS - Ansible AWS VPC Route Table append route for SAP AnyDB HA
      amazon.aws.ec2_vpc_route_table:
        lookup: id
        vpc_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].vpc_id }}"
        route_table_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].route_table_id }}"
        purge_subnets: false
        purge_routes: false
        state: present
        routes:
          - dest: "{{ sap_vm_provision_ha_vip_anydb_primary }}"
            instance_id: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_anydb_primary] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_vpc_subnet_rt_route_sap_anydb

    - name: SAP VM Provision - AWS - Ansible AWS Route53 DNS Records for SAP AnyDB HA Virtual Hostname
      amazon.aws.route53:
        state: present
        private_zone: true
        zone: "{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        record: "{{ __sap_vm_provision_fact_ha_hostname_anydb_primary }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        type: A
        ttl: 7200
        value: "{{ sap_vm_provision_ha_vip_anydb_primary | regex_replace('/.*', '') }}"
        wait: true
        overwrite: "{{ sap_vm_provision_aws_dns_overwrite if sap_vm_provision_aws_dns_overwrite | bool else false }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_anydb_primary] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_route53_sap_anydb


- name: Block for ASCS
  when: sap_vm_provision_fact_is_ha_nwas_ers
  no_log: "{{ __sap_vm_provision_no_log }}"
  block:
    # ASCS
    - name: SAP VM Provision - AWS - Ansible AWS VPC Route Table append route for SAP NetWeaver ASCS HA
      amazon.aws.ec2_vpc_route_table:
        lookup: id
        vpc_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].vpc_id }}"
        route_table_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].route_table_id }}"
        purge_subnets: false
        purge_routes: false
        state: present
        routes:
          - dest: "{{ sap_vm_provision_ha_vip_nwas_abap_ascs }}"
            instance_id: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_vpc_subnet_rt_route_sap_netweaver_ascs

    - name: SAP VM Provision - AWS - Ansible AWS Route53 DNS Records for SAP NetWeaver ASCS HA Virtual Hostname
      amazon.aws.route53:
        state: present
        private_zone: true
        zone: "{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        record: "{{ __sap_vm_provision_fact_ha_hostname_nwas_abap_ascs }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        type: A
        ttl: 7200
        value: "{{ sap_vm_provision_ha_vip_nwas_abap_ascs | regex_replace('/.*', '') }}"
        wait: true
        overwrite: "{{ sap_vm_provision_aws_dns_overwrite if sap_vm_provision_aws_dns_overwrite | bool else false }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ascs] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_route53_sap_netweaver_ascs


    # ERS
    - name: SAP VM Provision - AWS - Ansible AWS VPC Route Table append route for SAP NetWeaver ERS HA
      amazon.aws.ec2_vpc_route_table:
        lookup: id
        vpc_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].vpc_id }}"
        route_table_id: "{{ __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].route_table_id }}"
        purge_subnets: false
        purge_routes: false
        state: present
        routes:
          - dest: "{{ sap_vm_provision_ha_vip_nwas_abap_ers }}"
            instance_id: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_vpc_subnet_rt_route_sap_netweaver_ers

    - name: SAP VM Provision - AWS - Ansible AWS Route53 DNS Records for SAP NetWeaver ERS HA Virtual Hostname
      amazon.aws.route53:
        state: present
        private_zone: true
        zone: "{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        record: "{{ __sap_vm_provision_fact_ha_hostname_nwas_abap_ers }}.{{ hostvars[host_node].sap_vm_provision_dns_root_domain }}"
        type: A
        ttl: 7200
        value: "{{ sap_vm_provision_ha_vip_nwas_abap_ers | regex_replace('/.*', '') }}"
        wait: true
        overwrite: "{{ sap_vm_provision_aws_dns_overwrite if sap_vm_provision_aws_dns_overwrite | bool else false }}"
        access_key: "{{ sap_vm_provision_aws_access_key }}"
        secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
      loop: "{{ (groups[sap_vm_provision_group_nwas_ers] | d([])) }}"
      loop_control:
        loop_var: host_node
      register: __sap_vm_provision_register_aws_route53_sap_netweaver_ers


# Setup custom IAM Role name using sap_vm_provision_aws_ha_iam_role
- name: SAP VM Provision - AWS - IAM Role - Prepare IAM Role name
  ansible.builtin.set_fact:
    __sap_vm_provision_aws_ha_iam_role:
      "{{ sap_vm_provision_aws_ha_iam_role
       if sap_vm_provision_aws_ha_iam_role | d('') | length > 0
       else 'HA-Role-Pacemaker' }}"

# Following IAM Roles, Policies and Instance Profiles are created based on:
# https://documentation.suse.com/sbp/sap-15/html/SLES4SAP-hana-sr-guide-perfopt-15-aws/index.html#id-aws-roles-and-policies
# https://docs.aws.amazon.com/sap/latest/sap-netweaver/sles-netweaver-ha-settings.html#stonith
# https://access.redhat.com/articles/4175371#create-policies
# https://docs.aws.amazon.com/sap/latest/sap-netweaver/rhel-netweaver-ha-settings.html#stonith
# https://docs.aws.amazon.com/sap/latest/sap-hana/sap-hana-on-aws-cluster-configuration-prerequisites.html#sap-hana-on-aws-create-the-stonith-policy

- name: SAP VM Provision - AWS - IAM Role - {{ __sap_vm_provision_aws_ha_iam_role }}
  amazon.aws.iam_role:
    name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    assume_role_policy_document: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Effect": "Allow",
                  "Action": "sts:AssumeRole",
                  "Sid": "",
                  "Principal": {
                      "Service": "ec2.amazonaws.com"
                  }
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_role_ha_pacemaker
  no_log: "{{ __sap_vm_provision_no_log }}"

# AWS HA for SAP - DataProvider
- name: SAP VM Provision - AWS - IAM Policy - HA-Policy-DataProvider
  amazon.aws.iam_policy:
    state: present
    iam_type: role
    iam_name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    policy_name: "HA-Policy-DataProvider"
    policy_json: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Effect": "Allow",
                  "Action": [
                      "EC2:DescribeInstances",
                      "EC2:DescribeVolumes"
                  ],
                  "Resource": "*"
              },
              {
                  "Effect": "Allow",
                  "Action": "cloudwatch:GetMetricStatistics",
                  "Resource": "*"
              },
              {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::aws-sap-data-provider/config.properties"
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_policy_dataprovider
  no_log: "{{ __sap_vm_provision_no_log }}"

# AWS HA for SAP - OverlayVirtualIPAgent
- name: SAP VM Provision - AWS - IAM Policy - HA-Policy-OverlayVirtualIPAgent
  amazon.aws.iam_policy:
    state: present
    iam_type: role
    iam_name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    policy_name: "HA-Policy-OverlayVirtualIPAgent"
    policy_json: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "Stmt1424870324000",
                  "Effect": "Allow",
                  "Action":  "ec2:DescribeRouteTables",
                  "Resource": "*"
              },
              {
                  "Sid": "Stmt1424860166260",
                  "Action": [
                      "ec2:CreateRoute",
                      "ec2:ReplaceRoute"
                  ],
                  "Effect": "Allow",
                  "Resource": "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:route-table/{{
                    __sap_vm_provision_register_aws_vpc_subnet_rt_info.route_tables[0].route_table_id }}"
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_policy_overlayip
  no_log: "{{ __sap_vm_provision_no_log }}"

# AWS HA for SAP - STONITH of SAP HANA
- name: SAP VM Provision - AWS - IAM Policy - HA-Policy-STONITH-SAPHANA
  amazon.aws.iam_policy:
    state: present
    iam_type: role
    iam_name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    policy_name: "HA-Policy-STONITH-SAPHANA"
    policy_json: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "Stmt1424870324000",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:DescribeInstances",
                      "ec2:DescribeInstanceAttribute",
                      "ec2:DescribeTags"
                  ],
                  "Resource": "*"
              },
              {
                  "Sid": "Stmt1424870324001",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:ModifyInstanceAttribute",
                      "ec2:StartInstances",
                      "ec2:StopInstances",
                      "ec2:RebootInstances"
                  ],
                  "Resource": [
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_hana_primary][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}",
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_hana_secondary][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}"
                  ]
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_policy_stonith_saphana
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_hana

# AWS HA for SAP - STONITH of SAP ANYDB
- name: SAP VM Provision - AWS - IAM Policy - HA-Policy-STONITH-SAPANYDB
  amazon.aws.iam_policy:
    state: present
    iam_type: role
    iam_name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    policy_name: "HA-Policy-STONITH-SAPANYDB"
    policy_json: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "Stmt1424870324000",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:DescribeInstances",
                      "ec2:DescribeInstanceAttribute",
                      "ec2:DescribeTags"
                  ],
                  "Resource": "*"
              },
              {
                  "Sid": "Stmt1424870324001",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:ModifyInstanceAttribute",
                      "ec2:StartInstances",
                      "ec2:StopInstances",
                      "ec2:RebootInstances"
                  ],
                  "Resource": [
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_anydb_primary][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}",
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_anydb_secondary][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}"
                  ]
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_policy_stonith_sapanydb
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_anydb

# AWS HA for SAP - STONITH of SAP NWAS
- name: SAP VM Provision - AWS - IAM Policy - HA-Policy-STONITH-SAPNWAS
  amazon.aws.iam_policy:
    state: present
    iam_type: role
    iam_name: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    policy_name: "HA-Policy-STONITH-SAPNWAS"
    policy_json: |
      {
          "Version": "2012-10-17",
          "Statement": [
              {
                  "Sid": "Stmt1424870324000",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:DescribeInstances",
                      "ec2:DescribeInstanceAttribute",
                      "ec2:DescribeTags"
                  ],
                  "Resource": "*"
              },
              {
                  "Sid": "Stmt1424870324001",
                  "Effect": "Allow",
                  "Action": [
                      "ec2:ModifyInstanceAttribute",
                      "ec2:StartInstances",
                      "ec2:StopInstances"
                  ],
                  "Resource": [
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_nwas_ascs][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}",
                      "arn:aws:ec2:{{ sap_vm_provision_aws_region }}:{{ __sap_vm_provision_register_aws_account_info.account }}:instance/{{
                       hostvars[groups[sap_vm_provision_group_nwas_ers][0]].__sap_vm_provision_register_instance_info.instances[0].instance_id }}"
                  ]
              }
          ]
      }
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_policy_stonith_sapnwas
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_nwas_ers


- name: SAP VM Provision - AWS - IAM Role - Prepare IAM Instance Profile name
  ansible.builtin.set_fact:
    __sap_vm_provision_aws_ha_iam_instance_profile:
      "{{ sap_vm_provision_aws_ha_iam_instance_profile
       if sap_vm_provision_aws_ha_iam_instance_profile | d('') | length > 0
       else 'HA-Instance-Profile-Pacemaker-Cluster' }}"

# Equivalent to
# aws iam create-instance-profile --instance-profile-name "HA-Instance-Profile-Pacemaker-Cluster"
# aws iam add-role-to-instance-profile --role-name "HA-Role-Pacemaker" --instance-profile-name "HA-Instance-Profile-Pacemaker-Cluster"
- name: SAP VM Provision - AWS - Create IAM Instance Profile and attach AWS IAM Role - "HA-Instance-Profile-Pacemaker-Cluster"
  amazon.aws.iam_instance_profile:
    state: present
    name: "{{ __sap_vm_provision_aws_ha_iam_instance_profile }}"
    role: "{{ __sap_vm_provision_aws_ha_iam_role }}"
    path: "/"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  register: __sap_vm_provision_register_aws_iam_attach_role
  no_log: "{{ __sap_vm_provision_no_log }}"

# Equivalent to aws ec2 associate-iam-instance-profile
# --iam-instance-profile "Name=HA-Instance-Profile-Pacemaker-Cluster"
# --instance-id {{ hostvars[host_node].ansible_facts['board_asset_tag'] }}
- name: SAP VM Provision - AWS - Associate AWS IAM Instance Profile for SAP HANA
  amazon.aws.ec2_instance:
    instance_ids: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
    iam_instance_profile: "{{ __sap_vm_provision_aws_ha_iam_instance_profile }}"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  loop: "{{ [[groups[sap_vm_provision_group_hana_primary] | d([])], [groups[sap_vm_provision_group_hana_secondary] | d([])]] | flatten | select() }}"
  loop_control:
    loop_var: host_node
  register: __sap_vm_provision_register_aws_iam_associate_instance_saphana
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_hana
  ignore_errors: true

# Equivalent to aws ec2 associate-iam-instance-profile
# --iam-instance-profile "Name=HA-Instance-Profile-Pacemaker-Cluster"
# --instance-id {{ hostvars[host_node].ansible_facts['board_asset_tag'] }}
- name: SAP VM Provision - AWS - Associate AWS IAM Instance Profile for SAP ANYDB
  amazon.aws.ec2_instance:
    instance_ids: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
    iam_instance_profile: "{{ __sap_vm_provision_aws_ha_iam_instance_profile }}"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  loop: "{{ [[groups[sap_vm_provision_group_anydb_primary] | d([])], [groups[sap_vm_provision_group_anydb_secondary] | d([])]] | flatten | select() }}"
  loop_control:
    loop_var: host_node
  register: __sap_vm_provision_register_aws_iam_associate_instance_sapanydb
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_anydb
  ignore_errors: true

# Equivalent to aws ec2 associate-iam-instance-profile
# --iam-instance-profile "Name=HA-Instance-Profile-Pacemaker-Cluster"
# --instance-id {{ hostvars[host_node].ansible_facts['board_asset_tag'] }}
- name: SAP VM Provision - AWS - Associate AWS IAM Instance Profile for SAP NetWeaver
  amazon.aws.ec2_instance:
    instance_ids: "{{ hostvars[host_node].ansible_facts['board_asset_tag'] }}"
    iam_instance_profile: "{{ __sap_vm_provision_aws_ha_iam_instance_profile }}"
    access_key: "{{ sap_vm_provision_aws_access_key }}"
    secret_key: "{{ sap_vm_provision_aws_secret_access_key }}"
  loop: "{{ [[groups[sap_vm_provision_group_nwas_ascs] | d([])], [groups[sap_vm_provision_group_nwas_ers] | d([])],
    [groups[sap_vm_provision_group_nwas_pas] | d([])], [groups[sap_vm_provision_group_nwas_aas] | d([])]] | flatten | select() }}"
  loop_control:
    loop_var: host_node
  register: __sap_vm_provision_register_aws_iam_associate_instance_sapnwas
  no_log: "{{ __sap_vm_provision_no_log }}"
  when: sap_vm_provision_fact_is_ha_nwas_ers
  ignore_errors: true
