# SPDX-License-Identifier: Apache-2.0
---

- name: SAP VM Provision - IBM Cloud PowerVS - Set fact for IBM Power Infrastructure location to the colocated IBM Cloud Region
  ansible.builtin.set_fact:
    __sap_vm_provision_fact_ibmcloud_region:
      "{{ __sap_vm_provision_ibmcloud_powervs_location_to_ibmcloud_availability_zone[sap_vm_provision_ibmcloud_powervs_location]
        | regex_replace('-[0-9]', '') }}"
    __sap_vm_provision_fact_ibmcloud_powervs_region:
      "{{ __sap_vm_provision_ibmcloud_powervs_location_to_powervs_region[sap_vm_provision_ibmcloud_powervs_location] }}"


- name: Ansible Task block for looped provisioning of IBM Power Virtual Servers on IBM Cloud
  any_errors_fatal: true
  environment:
    # Sensitive variables are used by module parameters, not environment variables.
    # IC_API_KEY: "{{ sap_vm_provision_ibmcloud_api_key }}"
    IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_region }}"
    IC_ZONE: "{{ sap_vm_provision_ibmcloud_powervs_location }}" # Required only for IBM Power VS, to set IBM Power VS location
  block:

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify Resource Group info
      ibm.cloudcollection.ibm_resource_group_info:
        name: "{{ sap_vm_provision_ibmcloud_resource_group_name }}"
        # IBM Cloud credentials
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_resource_group
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    # DNS may exist in separate Resource Group
    # Use empty string var (or default false if undefined) to evaluate to false boolean
    - name: SAP VM Provision - IBM Cloud PowerVS - Identify Resource Group info for IBM Cloud Private DNS
      ibm.cloudcollection.ibm_resource_group_info:
        name: "{{ sap_vm_provision_ibmcloud_private_dns_resource_group_name }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_resource_group_dns
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true
      when: sap_vm_provision_ibmcloud_private_dns_resource_group_name | d('') | length > 0

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Power Infrastructure Workspace
      ibm.cloudcollection.ibm_resource_instance_info:
        resource_group_id: "{{ __sap_vm_provision_register_ibmcloud_resource_group.resource.id }}"
        location: "{{ sap_vm_provision_ibmcloud_powervs_location }}"
        service: power-iaas
        name: "{{ sap_vm_provision_ibmcloud_powervs_workspace_name }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Power Infrastructure Workspace capabilities
      ibm.cloudcollection.ibm_pi_workspace_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_workspace_capabilities
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify pre-loaded IBM Power Infrastructure SSH Public Key info
      ibm.cloudcollection.ibm_pi_key_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        pi_key_name: "{{ sap_vm_provision_ibmcloud_powervs_key_pair_name_ssh_host_public_key }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_ssh_public_key
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Power Infrastructure VLAN Subnet info
      ibm.cloudcollection.ibm_pi_network_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        pi_network_name: "{{ sap_vm_provision_ibmcloud_powervs_vlan_subnet_name }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_subnet
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Confirm IBM Power Infrastructure VLAN Subnet uses IBM Cloud IaaS Backbone DNS Resolver
      ansible.builtin.fail:
        msg:
          If IBM Power Infrastructure Workspace uses Power Edge Router (and not legacy Cloud Connection) networking configuration,
          then Subnet DNS Default should use IBM Cloud IaaS Backbone DNS Resolver 161.26.0.10/11 (which will be populated into /etc/resolv.conf).
          Otherwise cloud-init actions during provisioning may not be successful.
      when:
        - __sap_vm_provision_register_ibmcloud_pi_workspace_capabilities.resource.pi_workspace_capabilities['power-edge-router']
        - not (__sap_vm_provision_register_ibmcloud_pi_subnet.resource.dns | first) in ['161.26.0.10', '161.26.0.11']


    # DNS may exist in separate Resource Group
    # If previous identification task is skipped, use resource group else use the resource group defined for the Private DNS
    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Cloud Private DNS instance
      ibm.cloudcollection.ibm_resource_instance_info:
        resource_group_id: "{{ __sap_vm_provision_register_ibmcloud_resource_group.resource.id
          if __sap_vm_provision_register_ibmcloud_resource_group_dns.skipped | d(false)
          else __sap_vm_provision_register_ibmcloud_resource_group_dns.resource.id }}"
        location: global
        service: dns-svcs
        name: "{{ sap_vm_provision_ibmcloud_private_dns_instance_name }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_pdns_service_instance
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Cloud Private DNS Zone info
      ibm.cloudcollection.ibm_dns_zones_info:
        instance_id: "{{ __sap_vm_provision_register_ibmcloud_pdns_service_instance.resource.guid }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_pdns
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Cloud Private DNS Custom Resolvers info
      ibm.cloudcollection.ibm_dns_custom_resolvers_info:
        instance_id: "{{ __sap_vm_provision_register_ibmcloud_pdns_service_instance.resource.guid }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_pdns_custom_resolvers
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true

    - name: SAP VM Provision - IBM Cloud PowerVS - Check if input IBM Cloud Private DNS Customer Resolver IP exists
      ansible.builtin.fail:
        msg:
          IBM Cloud Private DNS instance does not contain the input Custom Resolver IP Address.
          Please create a Custom Resolver in this IBM Cloud Private DNS instance.
      when:
        - not sap_vm_provision_ibmcloud_private_dns_custom_resolver_ip
          in (__sap_vm_provision_register_ibmcloud_pdns_custom_resolvers.resource.custom_resolvers | map(attribute='locations')
            | list | flatten | map(attribute='dns_server_ip') | list)


    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Power Infrastructure OS Catalog Stock Image list
      ibm.cloudcollection.ibm_pi_catalog_images_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        sap: true # Return all OS Images for SAP
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_os_image_list
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true


    - name: SAP VM Provision - IBM Cloud PowerVS - Import Boot Image to current Workspace from the IBM Power Infrastructure OS Catalog Stock Image
      ibm.cloudcollection.ibm_pi_image:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        pi_image_id: "{{ __image.image_id }}"
        pi_image_name: "{{ sap_vm_provision_ibmcloud_powervs_host_os_image }}-boot"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_os_image_provisioned
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true
      vars:
        __image: "{{ __sap_vm_provision_register_ibmcloud_pi_os_image_list.resource.images
          | rejectattr('name', 'search', '.*BYOL.*')
          | selectattr('name', 'search',
            lookup('ansible.builtin.vars', __sap_vm_provision_host_image_dict_name)[sap_vm_provision_ibmcloud_powervs_host_os_image])
          | sort(reverse=True, case_sensitive=False, attribute='name') | first }}"
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_pi_os_image_provisioned.rc == 0
        - not 'already exists' in __sap_vm_provision_register_ibmcloud_pi_os_image_provisioned.stderr

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify IBM Power Infrastructure Workspace imported OS Image list
      ibm.cloudcollection.ibm_pi_images_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_imported_os_image_list
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true


    # Use check to avoid idempotency issues with legacy ibm.cloudcollection Ansible Collection (until ibm.cloud Ansible Collection is ready)
    - name: SAP VM Provision - IBM Cloud PowerVS - Check for existing Boot Image imported already from IBM Power Infrastructure OS Catalog Stock Image
      ibm.cloudcollection.ibm_pi_image_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        pi_image_name: "{{ register_ibmcloud_pi_imported_os_image_selected.name }}"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      environment:
        IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"  # Block override
      register: __sap_vm_provision_register_ibmcloud_pi_os_image_existing
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true
      vars:
        __image: "{{ __sap_vm_provision_register_ibmcloud_pi_imported_os_image_list.resource.image_info
          | rejectattr('name', 'search', '.*BYOL.*')
          | selectattr('name', 'search',
            lookup('ansible.builtin.vars', __sap_vm_provision_host_image_dict_name)[sap_vm_provision_ibmcloud_powervs_host_os_image])
          | sort(reverse=True, case_sensitive=False, attribute='name') | first }}"


    - name: SAP VM Provision - IBM Cloud PowerVS - Create IBM Power Infrastructure Server Placement Groups when High Availability
      ibm.cloudcollection.ibm_pi_placement_group:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        pi_placement_group_name: "{{ sap_vm_provision_ibmcloud_placement_resource_name }}-{{ placement_item }}"
        pi_placement_group_policy: "anti-affinity"
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      loop:
        - "{{ 'hana'
          if sap_vm_provision_group_hana_secondary in __sap_vm_provision_host_dict_plan | json_query('*') | map(attribute='sap_host_type')
          else '' }}"
        - "{{ 'anydb'
          if sap_vm_provision_group_anydb_secondary in __sap_vm_provision_host_dict_plan | json_query('*') | map(attribute='sap_host_type')
          else '' }}"
        - "{{ 'nwas'
          if sap_vm_provision_group_nwas_ers in __sap_vm_provision_host_dict_plan | json_query('*') | map(attribute='sap_host_type')
          else '' }}"
      loop_control:
        loop_var: placement_item
      register: __sap_vm_provision_register_ibmcloud_placement_group
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true
      when:
        - sap_vm_provision_ibmcloud_placement_resource_name | d('') | length > 0
        - sap_vm_provision_ibmcloud_placement_strategy_spread
        - not placement_item == ''

    - name: SAP VM Provision - IBM Cloud PowerVS - Identify created IBM Power Infrastructure Server Placement Groups when High Availability
      ibm.cloudcollection.ibm_pi_placement_groups_info:
        pi_cloud_instance_id: "{{ __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance.resource.guid }}" # must be GUID, not CRN
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_placement_groups_list
      no_log: "{{ __sap_vm_provision_no_log }}"
      run_once: true
      when:
        - sap_vm_provision_ibmcloud_placement_resource_name | d('') | length > 0
        - sap_vm_provision_ibmcloud_placement_strategy_spread


    - name: SAP VM Provision - IBM Cloud PowerVS - Provision IBM Power Virtual Server hosts on IBM Cloud
      ansible.builtin.include_tasks:
        file: "{{ __sap_vm_provision_task_file }}/execute_provision.yml"
        apply:
          environment:
            # IC_API_KEY: "{{ sap_vm_provision_ibmcloud_api_key }}"
            IC_REGION: "{{ __sap_vm_provision_fact_ibmcloud_powervs_region }}"
            IC_ZONE: "{{ sap_vm_provision_ibmcloud_powervs_location }}" # Required only for IBM Power VS, to set IBM Power VS location


    - name: SAP VM Provision - IBM Cloud PowerVS - Set Bastion SSH argument facts
      ansible.builtin.set_fact:
        __sap_vm_provision_fact_ssh_args_bastion: >-
          -o ProxyCommand='ssh -W %h:%p {{ sap_vm_provision_bastion_user }}@{{ sap_vm_provision_bastion_public_ip }}
          -p {{ sap_vm_provision_bastion_ssh_port }}
          -i {{ sap_vm_provision_ssh_bastion_private_key_file_path }}
          {{ sap_vm_provision_ssh_bastion_ssh_args }}'
      when:
        - sap_vm_provision_bastion_execution
        - sap_vm_provision_bastion_user | d('') != ''
        - sap_vm_provision_bastion_public_ip | d('') != ''
        - sap_vm_provision_bastion_ssh_port | d('') != ''
        - sap_vm_provision_ssh_bastion_private_key_file_path | d('') != ''


    - name: SAP VM Provision - IBM Cloud PowerVS - Add hosts provisioned to the Ansible Inventory
      ansible.builtin.add_host:
        name: "{{ add_item[0].host_node }}"
        groups: "{{ add_item[0].sap_system_type + '_' if (add_item[0].sap_system_type != '') }}{{ add_item[0].sap_host_type }}"
        ansible_host: "{{ add_item[0].resource.networks[0].ip }}"
        ansible_user: "root"
        ansible_ssh_private_key_file: "{{ sap_vm_provision_ssh_host_private_key_file_path }}"
        ansible_ssh_common_args: "{{ sap_vm_provision_ssh_host_ssh_args }} {{ __sap_vm_provision_fact_ssh_args_bastion | d('') }}"
      loop: "{{ ansible_play_hosts | map('extract', hostvars, '__sap_vm_provision_fact_provisioned_hosts') }}"
      loop_control:
        label: "{{ add_item[0].host_node }}"
        loop_var: add_item
      register: __sap_vm_provision_register_add_hosts
      no_log: "{{ __sap_vm_provision_no_log }}"

    - name: SAP VM Provision - IBM Cloud PowerVS - Set fact to hold all inventory hosts in all groups
      ansible.builtin.set_fact:
        __sap_vm_provision_fact_merged_hosts_list: "{{
            [[groups[sap_vm_provision_group_hana_primary] | d([])],
            [groups[sap_vm_provision_group_hana_secondary] | d([])],
            [groups[sap_vm_provision_group_anydb_primary] | d([])],
            [groups[sap_vm_provision_group_anydb_secondary] | d([])],
            [groups[sap_vm_provision_group_nwas_ascs] | d([])],
            [groups[sap_vm_provision_group_nwas_ers] | d([])],
            [groups[sap_vm_provision_group_nwas_pas] | d([])],
            [groups[sap_vm_provision_group_nwas_aas] | d([])]] | flatten | select() }}"


    - name: SAP VM Provision - IBM Cloud PowerVS - Identify hosts
      ansible.builtin.include_tasks:
        file: common/identify_hosts.yml

    - name: SAP VM Provision - IBM Cloud PowerVS - Set Ansible Vars
      ansible.builtin.include_tasks:
        file: common/set_ansible_vars.yml

    - name: SAP VM Provision - IBM Cloud PowerVS - IBM Cloud Private DNS Record for hosts
      ibm.cloudcollection.ibm_dns_resource_record:
        instance_id: "{{ __sap_vm_provision_register_ibmcloud_pdns_service_instance.resource.guid }}"
        zone_id: "{{ (__sap_vm_provision_register_ibmcloud_pdns.resource.dns_zones
          | selectattr('name', '==', sap_vm_provision_dns_root_domain) | first).zone_id }}"
        name: "{{ inventory_hostname }}.{{ hostvars[inventory_hostname].sap_vm_provision_dns_root_domain }}" # Host FQDN
        rdata: "{{ hostvars[inventory_hostname].ansible_host }}" # IP Address
        type: A
        ttl: 7200
        ibmcloud_api_key: "{{ sap_vm_provision_ibmcloud_api_key }}"
      register: __sap_vm_provision_register_ibmcloud_pdns_record
      no_log: "{{ __sap_vm_provision_no_log }}"
      failed_when:
        - not __sap_vm_provision_register_ibmcloud_pdns_record.rc == 0
        - not 'The record already exists' in __sap_vm_provision_register_ibmcloud_pdns_record.stderr


  rescue:
    # This requires no_log set on each Ansible Task, and not set on the Ansible Task Block
    # This requires an Ansible Task Block containing the Ansible Tasks for calling
    # Infrastructure Platform APIs (via Ansible Modules)
    - name: SAP VM Provision - IBM Cloud PowerVS - Show errors in task outputs
      ansible.builtin.fail:
        msg: "{{ lookup('ansible.builtin.vars', loop_item) }}"
      loop:
        # Main
        - __sap_vm_provision_register_ibmcloud_resource_group
        - __sap_vm_provision_register_ibmcloud_resource_group_dns
        - __sap_vm_provision_register_ibmcloud_pi_workspace_service_instance
        - __sap_vm_provision_register_ibmcloud_pi_ssh_public_key
        - __sap_vm_provision_register_ibmcloud_pi_subnet
        - __sap_vm_provision_register_ibmcloud_pi_os_image_list
        - __sap_vm_provision_register_ibmcloud_pdns_service_instance
        - __sap_vm_provision_register_ibmcloud_pdns
        - __sap_vm_provision_register_ibmcloud_pi_os_image_provisioned
        - __sap_vm_provision_register_ibmcloud_pi_os_image_existing
        - __sap_vm_provision_register_add_hosts
        - __sap_vm_provision_register_ibmcloud_pdns_record
        # Provision
        - __sap_vm_provision_register_provision_host_single
        - __sap_vm_provision_register_provision_host_single_volumes
        - __sap_vm_provision_register_provision_host_single_volumes_info
        - __sap_vm_provision_register_provision_host_single_volume_attachments
        - __sap_vm_provision_register_provision_host_single_info
        - __sap_vm_provision_register_gather_subset
        - __sap_vm_provision_register_update_sshd_config
      loop_control:
        loop_var: loop_item
        index_var: loop_item_index
        label: "{{ 'Variable No. ' + (loop_item_index | string) }}"
      when:
        - lookup('ansible.builtin.vars', loop_item, default='') | length > 0
        - not lookup('ansible.builtin.vars', loop_item, default='') is skipped
        - lookup('ansible.builtin.vars', loop_item, default='') is failed

    - name: SAP VM Provision - IBM Cloud PowerVS - Fail if provisioning failed
      ansible.builtin.fail:
        msg: |
          FAIL: Provisioning has failed during one of tasks not producing registered output.
          You can investigate failure in tasks above or by:
          - Increasing verbosity
          - Setting the variable '__sap_vm_provision_no_log' to 'false'


# New inventory hosts were created and they can be used without IP delegation.
- name: Ansible Task block to execute on target inventory hosts
  delegate_to: "{{ inventory_hostname }}"
  block:

    # Required to collect the remote host's facts for further processing
    # in the following steps
    - name: SAP VM Provision - IBM Cloud PowerVS - Gather host facts
      ansible.builtin.setup:

    # Must be set to short hostname,
    # so that command 'hostname' and 'hostname -s' return the short hostname only;
    # otherwise may cause error with SAP SWPM using name.domain.com.domain.com
    - name: SAP VM Provision - IBM Cloud PowerVS - Change system hostname (must be set to short name and not FQDN, as required by SAP)
      ansible.builtin.hostname:
        name: "{{ inventory_hostname_short }}"

    - name: SAP VM Provision - IBM Cloud PowerVS - Set /etc/hosts
      ansible.builtin.include_tasks:
        file: common/set_etc_hosts.yml

    - name: SAP VM Provision - IBM Cloud PowerVS - Set /etc/hosts for HA
      ansible.builtin.include_tasks:
        file: common/set_etc_hosts_ha.yml
      when:
        - __sap_vm_provision_fact_is_ha_hana or __sap_vm_provision_fact_is_ha_anydb or __sap_vm_provision_fact_is_ha_nwas_ers

    - name: SAP VM Provision - IBM Cloud PowerVS - Set /etc/hosts for Scale-Out
      ansible.builtin.include_tasks:
        file: common/set_etc_hosts_scaleout.yml
      when: __sap_vm_provision_fact_is_hana_scaleout

    - name: SAP VM Provision - IBM Cloud PowerVS - Set vars for sap_storage_setup Ansible Role
      ansible.builtin.include_tasks:
        file: common/set_ansible_vars_storage.yml

    - name: SAP VM Provision - IBM Cloud PowerVS - Append IBM Cloud Private DNS to /etc/resolv.conf
      ansible.builtin.lineinfile:
        path: /etc/resolv.conf
        line: nameserver {{ sap_vm_provision_ibmcloud_private_dns_custom_resolver_ip }}

    # Required Web Forward Proxy
    # For IBM PowerVS Workspace enabled with Power Edge Router (from Q4-2023 onwards),
    # the SNAT (VPC Public Gateway) service is not routable from IBM Power Virtual Server hosts
    # and cannot be used for outbound Public Internet connectivity
    # For IBM PowerVS Workspace with legacy Cloud Connection,
    # required for both outbound Public Internet connectivity and internal traffic to other IBM Cloud Services
    - name: SAP VM Provision - IBM Cloud PowerVS - Register Web Forward Proxy
      ansible.builtin.include_tasks:
        file: common/register_proxy.yml
      when: sap_vm_provision_proxy_web_forward_proxy_ip | d('') | length > 0

    # Not applicable to the IBM PowerVS Workspace enabled with Power Edge Router (from Q4-2023 onwards)
    # Extract the generated command string and activation key from /usr/share, then execute script from /usr/local/bin
    # Use nohup to ensure completion, wait 2 minutes
    # Verify with /var/log/rhsm/rhsm.log if necessary
    - name: SAP VM Provision - IBM Cloud PowerVS - Check for PowerVS FLS readme (legacy CC marker)
      ansible.builtin.stat:
        path: /usr/share/powervs-fls/powervs-fls-readme.md
      register: __sap_vm_provision_register_powervs_fls_readme_stat

    - name: Block for legacy activation
      when:
        - sap_vm_provision_os_registration_script_command | d('') | length == 0
        - sap_vm_provision_os_online_registration_user | d('') | length == 0
          or sap_vm_provision_os_online_registration_passcode | d('') | length == 0
        - not __sap_vm_provision_register_ibmcloud_pi_workspace_capabilities.resource.pi_workspace_capabilities['power-edge-router']
        - __sap_vm_provision_register_powervs_fls_readme_stat.stat.exists
      block:

        - name: SAP VM Provision - IBM Cloud PowerVS - Read PowerVS FLS readme for legacy CC
          ansible.builtin.slurp:
            src: /usr/share/powervs-fls/powervs-fls-readme.md
          register: __sap_vm_provision_register_powervs_fls_readme_slurp

        - name: SAP VM Provision - IBM Cloud PowerVS - Build activation command for legacy CC
          ansible.builtin.set_fact:
            __sap_vm_provision_register_ibmcloud_activation_script: >-
              {{
                (__sap_vm_provision_register_powervs_fls_readme_slurp.content | b64decode)
                | regex_search('.*networklayer\\.com.*', multiline=True)
                | regex_replace('Private\\.proxy\\.IP\\.address:3128', sap_vm_provision_proxy_web_forward_proxy_ip | d(''))
                | regex_replace('^.', '')
              }}

        - name: SAP VM Provision - IBM Cloud PowerVS - Execute activation command (legacy CC only)
          ansible.builtin.command:
            cmd: "{{ __sap_vm_provision_register_ibmcloud_activation_script }}"
          async: 300
          poll: 0
          changed_when: true

        - name: SAP VM Provision - IBM Cloud PowerVS - Wait for activation completion
          ansible.builtin.pause:
            seconds: 120

        - name: SAP VM Provision - IBM Cloud PowerVS - Register SLES PackageHub
          ansible.builtin.command:
            cmd: SUSEConnect --product PackageHub/{{ ansible_distribution_version }}/ppc64le
          when: ansible_facts['os_family'] == 'Suse'
          changed_when: true


    - name: SAP VM Provision - IBM Cloud PowerVS - Register Package Repositories for OS Images with Bring-Your-Own-Subscription (BYOS)
      ansible.builtin.include_tasks:
        file: common/register_os.yml

    - name: SAP VM Provision - IBM Cloud PowerVS - Verify connection to NFS
      ansible.builtin.wait_for:
        host: "{{ sap_vm_provision_nfs_mount_point | regex_replace(':.*', '') }}"
        port: 2049
        delay: 10
        sleep: 10
        connect_timeout: 15
        timeout: 120
      when: sap_vm_provision_nfs_mount_point | d('') | length > 0

    - name: SAP VM Provision - IBM Cloud PowerVS - Verify connection to separate NFS for SAP Transport Directory
      ansible.builtin.wait_for:
        host: "{{ sap_vm_provision_nfs_mount_point_separate_sap_transport_dir | regex_replace(':.*', '') }}"
        port: 2049
        delay: 10
        sleep: 10
        connect_timeout: 15
        timeout: 120
      when: sap_vm_provision_nfs_mount_point_separate_sap_transport_dir | d('')| length > 0

    # Ensure lock to RHEL major.minor version
    # Lock using subscription-manager release --set or /var/lib/rhsm/cache/releasever.json,
    # alternatively using /etc/yum/vars/releasever or /etc/dnf/vars/releasever

    # Reason for noqa: This is setting variables for usage in end to end playbooks.
    - name: SAP VM Provision - IBM Cloud PowerVS - Set facts on each host - HA/DR  # noqa var-naming[no-role-prefix]
      ansible.builtin.set_fact:
        # Assume IBM Power Virtual Server vNIC is set as default (e.g. env2)
        sap_ha_pacemaker_cluster_vip_client_interface:
          "{{ ansible_facts['default_ipv4']['interface'] }}"
      when: sap_ha_pacemaker_cluster_ibmcloud_api_key | d('') | length > 0
